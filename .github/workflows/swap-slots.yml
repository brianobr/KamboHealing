name: Swap Azure App Service Slots

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "SWAP" to confirm slot swap from staging to production'
        required: true
        type: string
      reason:
        description: 'Reason for slot swap (optional)'
        required: false
        type: string
        default: 'Manual slot swap via GitHub Actions'

jobs:
  swap-slots:
    runs-on: ubuntu-latest
    name: Swap Staging and Production Slots
    
    steps:
    - name: Validate Confirmation
      run: |
        if [ "${{ github.event.inputs.confirmation }}" != "SWAP" ]; then
          echo "❌ Confirmation failed. You must type 'SWAP' to proceed."
          exit 1
        fi
        echo "✅ Confirmation validated"
        
    - name: Log Swap Details
      run: |
        echo "🔄 Starting slot swap process"
        echo "📅 Timestamp: $(date)"
        echo "👤 Triggered by: ${{ github.actor }}"
        echo "📝 Reason: ${{ github.event.inputs.reason }}"
        echo "🎯 Action: Swapping staging slot to production"
        
    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_8B3B1C8F7D4D4A5E9B8C1E6F2A5D8C9B }}
        tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_1A2B3C4D5E6F7A8B9C0D1E2F3A4B5C6D }}
        subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_7D8E9F0A1B2C3D4E5F6A7B8C9D0E1F2A }}
        
    - name: Swap Slots
      uses: azure/CLI@v1
      with:
        azcliversion: 2.30.0
        inlineScript: |
          echo "🔄 Initiating slot swap..."
          
          # Get current slot configurations
          echo "📋 Current slot status:"
          az webapp deployment slot list \
            --name app-kambohealing \
            --resource-group rg-kambohealing \
            --query '[].{Name:name, State:state, DefaultHostName:defaultHostName}' \
            --output table
          
          # Perform the slot swap
          echo "🔄 Swapping staging slot to production..."
          az webapp deployment slot swap \
            --name app-kambohealing \
            --resource-group rg-kambohealing \
            --slot staging \
            --target-slot production
          
          # Wait for swap to complete
          echo "⏳ Waiting for slot swap to complete..."
          sleep 30
          
          # Verify swap completed
          echo "✅ Slot swap completed. New slot status:"
          az webapp deployment slot list \
            --name app-kambohealing \
            --resource-group rg-kambohealing \
            --query '[].{Name:name, State:state, DefaultHostName:defaultHostName}' \
            --output table
            
    - name: Verify Production Health
      run: |
        echo "🏥 Checking production health..."
        
        # Wait a moment for the swap to fully propagate
        sleep 15
        
        # Health check on production URL
        PROD_URL="https://app-kambohealing.azurewebsites.net"
        
        echo "🌐 Testing production URL: $PROD_URL"
        
        # Perform health check with retry logic
        for i in {1..5}; do
          echo "🔍 Health check attempt $i/5..."
          
          if curl -s -f -o /dev/null -w "%{http_code}" "$PROD_URL" | grep -q "200\|301\|302"; then
            echo "✅ Production site is responding successfully"
            break
          else
            echo "⚠️  Production site not responding, retrying in 10 seconds..."
            sleep 10
          fi
          
          if [ $i -eq 5 ]; then
            echo "❌ Production health check failed after 5 attempts"
            echo "🚨 Consider manual verification or rollback"
            exit 1
          fi
        done
        
    - name: Post Swap Summary
      run: |
        echo "🎉 Slot swap completed successfully!"
        echo ""
        echo "📊 Swap Summary:"
        echo "  • Staging content is now live in production"
        echo "  • Previous production content is now in staging slot"
        echo "  • Production URL: https://app-kambohealing.azurewebsites.net"
        echo "  • Staging URL: https://app-kambohealing-staging.azurewebsites.net"
        echo ""
        echo "🔄 Rollback: If needed, run this workflow again to swap back"
        echo "📝 Reason: ${{ github.event.inputs.reason }}"
        echo "👤 Performed by: ${{ github.actor }}"
        echo "📅 Completed at: $(date)"